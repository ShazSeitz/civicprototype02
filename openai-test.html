<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenAI API Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      line-height: 1.5;
    }
    .container {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-top: 1rem;
    }
    input, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.25rem;
      font-size: 1rem;
    }
    button {
      background-color: #3b82f6;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #2563eb;
    }
    .success {
      color: #10b981;
      font-weight: bold;
    }
    .error {
      color: #ef4444;
      font-weight: bold;
    }
    pre {
      background-color: #f9fafb;
      padding: 1rem;
      border-radius: 0.25rem;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>OpenAI API Direct Test</h1>
  
  <div class="container">
    <h2>API Key Configuration</h2>
    <p>Enter your OpenAI API key below (starts with sk-)</p>
    <input type="text" id="apiKey" placeholder="sk-..." value="">
    <button id="saveApiKey">Save API Key</button>
    <p id="apiKeyStatus"></p>
  </div>
  
  <div class="container">
    <h2>Test Priority Mapping</h2>
    <p>Enter a priority to test the OpenAI API mapping</p>
    <textarea id="priority" rows="3" placeholder="Enter your priority here (e.g., 'I want better public transportation')"></textarea>
    <button id="testApi">Test API</button>
  </div>
  
  <div class="container hidden" id="resultContainer">
    <h2>API Response</h2>
    <pre id="apiResponse"></pre>
  </div>
  
  <script>
    // Check for existing API key
    document.addEventListener('DOMContentLoaded', function() {
      const storedApiKey = localStorage.getItem('openai_api_key');
      if (storedApiKey) {
        document.getElementById('apiKey').value = storedApiKey;
        document.getElementById('apiKeyStatus').innerHTML = '<span class="success">API key is configured</span>';
      }
    });
    
    // Save API key
    document.getElementById('saveApiKey').addEventListener('click', function() {
      const apiKey = document.getElementById('apiKey').value.trim();
      
      if (!apiKey || !apiKey.startsWith('sk-')) {
        document.getElementById('apiKeyStatus').innerHTML = '<span class="error">Invalid API key format. API keys should start with "sk-"</span>';
        return;
      }
      
      localStorage.setItem('openai_api_key', apiKey);
      document.getElementById('apiKeyStatus').innerHTML = '<span class="success">API key saved successfully</span>';
    });
    
    // Test API
    document.getElementById('testApi').addEventListener('click', async function() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const priority = document.getElementById('priority').value.trim();
      
      if (!apiKey) {
        document.getElementById('apiResponse').innerHTML = '<span class="error">Please enter an API key first</span>';
        document.getElementById('resultContainer').classList.remove('hidden');
        return;
      }
      
      if (!priority) {
        document.getElementById('apiResponse').innerHTML = '<span class="error">Please enter a priority</span>';
        document.getElementById('resultContainer').classList.remove('hidden');
        return;
      }
      
      document.getElementById('apiResponse').innerHTML = 'Loading...';
      document.getElementById('resultContainer').classList.remove('hidden');
      
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4',
            messages: [
              {
                role: 'system',
                content: `You are a sophisticated political analysis system that maps voter priorities to standardized policy terms. Your task is to analyze each priority statement and map it to the most relevant policy terms, capturing nuance and intent.`
              },
              {
                role: 'user',
                content: `
I need you to analyze the following voter priority and map it to relevant policy terms:
"${priority}"

Respond with a JSON object with the following structure:
{
  "original": "${priority}",
  "category": "Economic/Social/Environmental/Healthcare/Education/Foreign Policy/Governance/Technology/Other",
  "mappedTerms": ["Policy Term 1", "Policy Term 2", ...],
  "sentiment": "positive/negative/neutral",
  "confidence": 0.0-1.0,
  "needsClarification": true/false,
  "possibleTopics": ["Possible Topic 1", "Possible Topic 2", ...] // only if needsClarification is true
}

Use specific, standardized policy terms for mappedTerms like:
- "Tax Reform" instead of "taxes"
- "Healthcare Access" instead of "medical care"
- "Climate Policy" instead of "environment"
- "Criminal Justice Reform" instead of "crime"
- "Immigration Reform" instead of "immigrants"
- "Election System Reform" instead of "voting"
- "Education Funding" instead of "schools"

For partisan statements without specific policy content, set needsClarification to true and suggest possible topics.
`
              }
            ],
            temperature: 0.3,
            max_tokens: 1000
          })
        });
        
        if (!response.ok) {
          const errorData = await response.text();
          let errorMessage = 'Unknown error';
          
          try {
            const parsedError = JSON.parse(errorData);
            errorMessage = parsedError.error?.message || 'Unknown error';
          } catch (e) {
            errorMessage = errorData || 'Unknown error';
          }
          
          throw new Error(`OpenAI API error: ${errorMessage}`);
        }
        
        const data = await response.json();
        const content = data.choices[0]?.message?.content;
        
        if (!content) {
          throw new Error('No content in OpenAI response');
        }
        
        // Format the JSON response
        try {
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          
          if (jsonMatch) {
            const jsonStr = jsonMatch[0];
            const parsedData = JSON.parse(jsonStr);
            document.getElementById('apiResponse').innerHTML = JSON.stringify(parsedData, null, 2);
          } else {
            document.getElementById('apiResponse').innerHTML = content;
          }
        } catch (e) {
          document.getElementById('apiResponse').innerHTML = content;
        }
      } catch (error) {
        document.getElementById('apiResponse').innerHTML = `<span class="error">${error.message}</span>`;
      }
    });
  </script>
</body>
</html>
